name: AI Guardrail DevSecOps Pipeline

on:
  push:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Risolve il warning "Shallow clone detected"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt
          # Installiamo anche le dipendenze per i test e la coverage
          pip install pytest pytest-cov requests-mock fastapi httpx

      - name: Run tests with coverage
        run: |
          # Impostiamo il PYTHONPATH cosÃ¬ Python vede la cartella app
          export PYTHONPATH=$PYTHONPATH:$(pwd)/app
          # Eseguiamo i test solo nella cartella app/tests e generiamo il report nel path corretto
          pytest app/tests/ --cov=app --cov-report=xml:app/coverage.xml

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.sources=app
            -Dsonar.tests=app/tests
            -Dsonar.python.coverage.reportPaths=app/coverage.xml
            -Dsonar.projectKey=n26-lab  

  deploy-to-aws:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
  
      - name: Install AWS CDK
        run: npm install -g aws-cdk
  
      - name: Install Dependencies
        working-directory: ./infrastructure
        run: pip install -r requirements.txt
            
      - name: CDK Deploy
        working-directory: ./infrastructure
        run: cdk deploy --all --require-approval never
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "eu-central-1"